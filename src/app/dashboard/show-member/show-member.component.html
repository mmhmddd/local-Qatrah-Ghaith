<div class="container">
  <app-sidebar></app-sidebar>

  <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
    <div class="container-fluid mt-4">
      <div *ngIf="toastMessage" class="toast" [ngClass]="{'toast-success': toastMessage.type === 'success', 'toast-error': toastMessage.type === 'error'}">
        {{ toastMessage.message }}
      </div>

      <div *ngIf="member" class="card shadow-sm">
        <div class="card-header text-white">
          <h3 class="mb-0">تفاصيل العضو: {{ member.name }}</h3>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-4">الاسم:</dt>
                <dd class="col-sm-8">{{ member.name }}</dd>
                <dt class="col-sm-4">البريد الإلكتروني:</dt>
                <dd class="col-sm-8">{{ member.email }}</dd>
                <dt class="col-sm-4">الهاتف:</dt>
                <dd class="col-sm-8">{{ member.phone }}</dd>
                <dt class="col-sm-4">العنوان:</dt>
                <dd class="col-sm-8">{{ member.address }}</dd>
                <dt class="col-sm-4">التخصص الأكاديمي:</dt>
                <dd class="col-sm-8">{{ member.academicSpecialization }}</dd>
              </dl>
            </div>
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-4">الحالة:</dt>
                <dd class="col-sm-8">{{ member.status }}</dd>
                <dt class="col-sm-4">تاريخ الإنشاء:</dt>
                <dd class="col-sm-8">{{ member.createdAt }}</dd>
                <dt class="col-sm-4">ساعات التطوع:</dt>
                <dd class="col-sm-8">{{ editMode ? '' : member.volunteerHours }}</dd>
                <dt class="col-sm-4">عدد الطلاب:</dt>
                <dd class="col-sm-8">{{ member.numberOfStudents }}</dd>
                <dt class="col-sm-4">عدد المحاضرات:</dt>
                <dd class="col-sm-8">{{ member.lectureCount }}</dd>
              </dl>
            </div>
          </div>

          <div *ngIf="editMode" class="mt-4">
            <h4>تعديل التفاصيل</h4>
            <div class="mb-3">
              <label for="volunteerHours" class="form-label">ساعات التطوع</label>
              <input type="number" class="form-control" id="volunteerHours" [(ngModel)]="editedVolunteerHours" min="0" dir="rtl">
            </div>
            <div class="mb-3">
              <label class="form-label">المواد</label>
              <div class="input-group mb-2">
                <input type="text" class="form-control" #newSubject placeholder="أدخل مادة جديدة" dir="rtl">
                <button class="btn btn-outline-secondary" (click)="addSubject(newSubject.value); newSubject.value=''">إضافة</button>
              </div>
              <ul class="list-group">
                <li class="list-group-item d-flex justify-content-between align-items-center" *ngFor="let subject of editedSubjects; let i = index">
                  {{ subject }}
                  <button class="btn btn-sm btn-danger" (click)="removeSubject(i)">حذف</button>
                </li>
              </ul>
            </div>
            <div class="mb-3">
              <label class="form-label">الطلاب</label>
              <div class="table-responsive">
                <table class="table table-bordered">
                  <thead>
                    <tr>
                      <th>الاسم</th>
                      <th>البريد الإلكتروني</th>
                      <th>الهاتف</th>
                      <th>الصف</th>
                      <th>المواد</th>
                      <th>الإجراءات</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let student of editedStudents; let i = index">
                      <td><input type="text" class="form-control" [(ngModel)]="student.name" dir="rtl"></td>
                      <td><input type="email" class="form-control" [(ngModel)]="student.email" dir="rtl"></td>
                      <td><input type="text" class="form-control" [(ngModel)]="student.phone" dir="rtl"></td>
                      <td><input type="text" class="form-control" [(ngModel)]="student.grade" placeholder="الصف (اختياري)" dir="rtl"></td>
                      <td><input type="text" class="form-control" [ngModel]="student.subjects.join(', ')" (ngModelChange)="updateStudentSubjects(i, $event)" placeholder="المواد (مفصولة بفواصل)" dir="rtl"></td>
                      <td><button class="btn btn-danger btn-sm" (click)="deleteStudent(i)">حذف</button></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="button-group">
              <button class="btn btn-primary me-2" (click)="saveChanges()">حفظ التغييرات</button>
              <button class="btn btn-secondary" (click)="toggleEditMode()">إلغاء</button>
            </div>
          </div>

          <div *ngIf="!editMode" class="mt-3">
            <button class="btn btn-primary" (click)="toggleEditMode()">تعديل التفاصيل</button>
          </div>
        </div>
      </div>

      <div class="card shadow-sm mt-4" *ngIf="member">
        <div class="card-header bg-secondary text-white">
          <h4 class="mb-0">إضافة طالب</h4>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <div class="mb-3">
                <label for="studentName" class="form-label">الاسم</label>
                <input type="text" class="form-control" id="studentName" [(ngModel)]="newStudent.name" dir="rtl">
              </div>
            </div>
            <div class="col-md-3">
              <div class="mb-3">
                <label for="studentEmail" class="form-label">البريد الإلكتروني</label>
                <input type="email" class="form-control" id="studentEmail" [(ngModel)]="newStudent.email" dir="rtl">
              </div>
            </div>
            <div class="col-md-3">
              <div class="mb-3">
                <label for="studentPhone" class="form-label">الهاتف</label>
                <input type="text" class="form-control" id="studentPhone" [(ngModel)]="newStudent.phone" dir="rtl">
              </div>
            </div>
            <div class="col-md-3">
              <div class="mb-3">
                <label for="studentGrade" class="form-label">الصف (اختياري)</label>
                <input type="text" class="form-control" id="studentGrade" [(ngModel)]="newStudent.grade" dir="rtl">
              </div>
            </div>
            <div class="col-md-3">
              <div class="mb-3">
                <label for="subjectCount" class="form-label">عدد المواد</label>
                <select class="form-control" id="subjectCount" [(ngModel)]="subjectCount" (ngModelChange)="updateSubjectInputs()">
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                </select>
              </div>
            </div>
            <div class="col-md-3" *ngFor="let subjectInput of subjectInputs; let i = index; trackBy: trackByIndex" [attr.key]="i">
              <div class="mb-3">
                <label for="studentSubject{{i}}" class="form-label">المادة {{i + 1}}</label>
                <input type="text" class="form-control" id="studentSubject{{i}}" [(ngModel)]="subjectInputs[i]" placeholder="أدخل اسم المادة" name="studentSubject{{i}}" dir="rtl">
              </div>
            </div>
          </div>
          <div class="button-group">
            <button class="btn btn-success" (click)="addStudent()">إضافة طالب</button>
            <button class="btn btn-secondary" (click)="clearSubjectInputs()">مسح المواد</button>
          </div>
        </div>
      </div>

      <div class="card shadow-sm mt-4" *ngIf="member">
        <div class="card-header bg-secondary text-white">
          <h4 class="mb-0">قائمة الطلاب</h4>
        </div>
        <div class="card-body">
          <div *ngIf="member.students.length === 0" class="alert alert-info">لا يوجد طلاب مسجلين.</div>
          <div class="table-responsive" *ngIf="member.students.length > 0">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>الاسم</th>
                  <th>البريد الإلكتروني</th>
                  <th>الهاتف</th>
                  <th>الصف</th>
                  <th>المواد</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let student of member.students">
                  <td>{{ student.name }}</td>
                  <td>{{ student.email }}</td>
                  <td>{{ student.phone }}</td>
                  <td>{{ student.grade || 'غير محدد' }}</td>
                  <td>{{ student.subjects.join(', ') || 'غير محدد' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card shadow-sm mt-4" *ngIf="member">
        <div class="card-header bg-secondary text-white">
          <h4 class="mb-0">المحاضرات</h4>
        </div>
        <div class="card-body">
          <div *ngIf="member.showLectureWarning" class="alert alert-warning">
            تحذير: لقد قمت برفع أقل من 2 محاضرة هذا الشهر. يرجى زيادة المحاضرات!
          </div>
          <div *ngIf="member.lectures.length === 0" class="alert alert-info">لا توجد محاضرات مسجلة.</div>
          <div class="table-responsive" *ngIf="member.lectures.length > 0">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>اسم المحاضرة</th>
                  <th>المادة</th>
                  <th>الرابط</th>
                  <th>تاريخ الإنشاء</th>
                  <th>الإجراءات</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let lecture of member.lectures; let i = index">
                  <td>{{ lecture.name }}</td>
                  <td>{{ lecture.subject }}</td>
                  <td><a [href]="lecture.link" target="_blank" class="text-primary">{{ lecture.link }}</a></td>
                  <td>{{ lecture.createdAt }}</td>
                  <td><button class="btn btn-danger btn-sm" (click)="deleteLecture(i)">حذف</button></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card shadow-sm mt-4" *ngIf="member">
        <div class="card-header bg-secondary text-white">
          <h4 class="mb-0">المواد</h4>
        </div>
        <div class="card-body">
          <div *ngIf="member.subjects.length === 0" class="alert alert-info">لا توجد مواد مسجلة.</div>
          <ul class="list-group" *ngIf="member.subjects.length > 0">
            <li class="list-group-item" *ngFor="let subject of member.subjects">{{ subject }}</li>
          </ul>
        </div>
      </div>

      <div class="card shadow-sm mt-4" *ngIf="member">
        <div class="card-header bg-secondary text-white">
          <h4 class="mb-0">إدارة الرسائل</h4>
        </div>
        <div class="card-body">
          <div *ngIf="isLoadingMessages" class="alert alert-info">جاري تحميل الرسائل...</div>
          <div *ngIf="!isLoadingMessages && activeMessage" class="mb-3">
            <h5>الرسالة النشطة</h5>
            <p><strong>المحتوى:</strong> {{ activeMessage.content }}</p>
            <p><strong>تنتهي في:</strong> {{ activeMessage.displayUntil | date:'medium' }}</p>
            <div class="button-group">
              <button class="btn btn-danger" (click)="deleteMessage()">حذف الرسالة</button>
            </div>
          </div>
          <div *ngIf="!isLoadingMessages && !activeMessage" class="mt-3">
            <h5>إرسال رسالة جديدة</h5>
            <div class="mb-3">
              <label for="newMessageContent" class="form-label">نص الرسالة</label>
              <textarea class="form-control" id="newMessageContent" [(ngModel)]="newMessage.content" rows="4" dir="rtl"></textarea>
              <small *ngIf="messageError.content" class="text-danger">{{ messageError.content }}</small>
            </div>
            <div class="mb-3">
              <label for="newMessageDisplayDays" class="form-label">مدة العرض (أيام)</label>
              <input type="number" class="form-control" id="newMessageDisplayDays" [(ngModel)]="newMessage.displayDays" min="1" max="30" dir="rtl">
              <small *ngIf="messageError.displayDays" class="text-danger">{{ messageError.displayDays }}</small>
            </div>
            <div class="button-group">
              <button class="btn btn-success" (click)="sendMessage()" [disabled]="!newMessage.content.trim() || !newMessage.displayDays">إرسال الرسالة</button>
            </div>
          </div>
          <div *ngIf="!isLoadingMessages && !activeMessage && !newMessage.content" class="alert alert-info">
            لا توجد رسائل نشطة حاليًا. يمكنك إرسال رسالة جديدة.
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
