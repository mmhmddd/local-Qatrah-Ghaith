<div class="container">
  <app-sidebar></app-sidebar>

  <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
    <div *ngFor="let toast of toasts"
         class="toast show"
         [id]="toast.id"
         [ngClass]="{'toast-success': toast.type === 'success', 'toast-error': toast.type === 'error'}"
         role="alert"
         aria-live="assertive"
         aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">{{ toast.title }}</strong>
        <button type="button" class="btn-close" (click)="closeToast(toast.id)"></button>
      </div>
      <div class="toast-body">
        {{ toast.message }}
      </div>
    </div>
  </div>

  <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
    <div class="container-fluid mt-4">
      <div *ngIf="member" class="card shadow-sm">
        <div class="card-header text-white bg-primary">
          <h3 class="mb-0">تفاصيل العضو: {{ member.name }}</h3>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-4">الاسم:</dt>
                <dd class="col-sm-8">{{ member.name }}</dd>
                <dt class="col-sm-4">البريد الإلكتروني:</dt>
                <dd class="col-sm-8">{{ member.email }}</dd>
                <dt class="col-sm-4">الهاتف:</dt>
                <dd class="col-sm-8">{{ member.phone }}</dd>
                <dt class="col-sm-4">العنوان:</dt>
                <dd class="col-sm-8">{{ member.address }}</dd>
                <dt class="col-sm-4">التخصص الأكاديمي:</dt>
                <dd class="col-sm-8">{{ member.academicSpecialization }}</dd>
              </dl>
            </div>
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-4">الحالة:</dt>
                <dd class="col-sm-8">{{ member.status }}</dd>
                <dt class="col-sm-4">تاريخ الإنشاء:</dt>
                <dd class="col-sm-8">{{ member.createdAt }}</dd>
                <dt class="col-sm-4">ساعات التطوع:</dt>
                <dd class="col-sm-8">{{ editMode ? '' : member.volunteerHours }}</dd>
                <dt class="col-sm-4">عدد الطلاب:</dt>
                <dd class="col-sm-8">{{ member.numberOfStudents }}</dd>
                <dt class="col-sm-4">عدد المحاضرات:</dt>
                <dd class="col-sm-8">{{ member.lectureCount }}</dd>
              </dl>
            </div>
          </div>

          <div *ngIf="editMode" class="mt-4">
            <h4>تعديل التفاصيل</h4>
            <div class="mb-3">
              <label for="volunteerHours" class="form-label">ساعات التطوع</label>
              <input type="number" class="form-control" id="volunteerHours" [(ngModel)]="editedVolunteerHours" min="0" dir="rtl">
            </div>
            <div class="mb-3">
              <label class="form-label">المواد</label>
              <div class="input-group mb-2">
                <input type="text" class="form-control" #newSubject placeholder="أدخل مادة جديدة" dir="rtl">
                <button class="btn btn-outline-secondary" (click)="addSubject(newSubject.value); newSubject.value=''">إضافة</button>
              </div>
              <ul class="list-group">
                <li class="list-group-item d-flex justify-content-between align-items-center" *ngFor="let subject of editedSubjects; let i = index">
                  {{ subject }}
                  <button class="btn btn-sm btn-danger" (click)="removeSubject(i)">حذف</button>
                </li>
              </ul>
            </div>
            <div class="mb-3">
              <label class="form-label">الطلاب</label>
              <div class="table-responsive">
                <table class="table table-bordered">
                  <thead>
                    <tr>
                      <th>الاسم</th>
                      <th>البريد الإلكتروني</th>
                      <th>الهاتف</th>
                      <th>الصف</th>
                      <th>المواد</th>
                      <th>الحد الأدنى للمحاضرات</th>
                      <th>الإجراءات</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let student of editedStudents; let i = index">
                      <td><input type="text" class="form-control" [(ngModel)]="student.name" dir="rtl" required></td>
                      <td><input type="email" class="form-control" [(ngModel)]="student.email" dir="rtl" required></td>
                      <td><input type="text" class="form-control" [(ngModel)]="student.phone" dir="rtl" required></td>
                      <td><input type="text" class="form-control" [(ngModel)]="student.grade" placeholder="الصف (اختياري)" dir="rtl"></td>
                      <td>
                        <input type="text" class="form-control" [(ngModel)]="student.subjectsString" (ngModelChange)="updateStudentSubjects(i, $event)" placeholder="المواد (مفصولة بفواصل)" dir="rtl">
                        <small *ngIf="student.subjectsString && !isValidSubjects(student.subjects)" class="text-danger">يرجى إدخال مواد صالحة من قائمة المواد المتاحة</small>
                      </td>
                      <td>
                        <div *ngFor="let subject of student.subjects; let j = index">
                          <input type="number" class="form-control mb-1" [(ngModel)]="student.subjects[j].minLectures" placeholder="الحد الأدنى للمحاضرات لـ {{ subject.name }}" min="0" dir="rtl" required>
                        </div>
                      </td>
                      <td><button class="btn btn-danger btn-sm" (click)="deleteStudent(i)">حذف</button></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="button-group">
              <button class="btn btn-primary me-2" (click)="saveChanges()" [disabled]="!isValidEditedStudents()">حفظ التغييرات</button>
              <button class="btn btn-secondary" (click)="toggleEditMode()">إلغاء</button>
            </div>
          </div>

          <div *ngIf="!editMode" class="mt-3">
            <button class="btn btn-primary" (click)="toggleEditMode()">تعديل التفاصيل</button>
          </div>
        </div>
      </div>

      <div class="card shadow-sm mt-4" *ngIf="member">
        <div class="card-header bg-secondary text-white">
          <h4 class="mb-0">إضافة طالب</h4>
        </div>
        <div class="card-body">
          <form #studentForm="ngForm" (ngSubmit)="addStudent(studentForm)">
            <div class="row">
              <div class="col-md-3">
                <div class="mb-3">
                  <label for="studentName" class="form-label">الاسم</label>
                  <input type="text" class="form-control" id="studentName" [(ngModel)]="newStudent.name" name="name" dir="rtl" required>
                  <small *ngIf="studentErrors.name" class="text-danger">{{ studentErrors.name }}</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="mb-3">
                  <label for="studentEmail" class="form-label">البريد الإلكتروني</label>
                  <input type="email" class="form-control" id="studentEmail" [(ngModel)]="newStudent.email" name="email" dir="rtl" required>
                  <small *ngIf="studentErrors.email" class="text-danger">{{ studentErrors.email }}</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="mb-3">
                  <label for="studentPhone" class="form-label">الهاتف</label>
                  <input type="text" class="form-control" id="studentPhone" [(ngModel)]="newStudent.phone" name="phone" dir="rtl" required>
                  <small *ngIf="studentErrors.phone" class="text-danger">{{ studentErrors.phone }}</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="mb-3">
                  <label for="studentGrade" class="form-label">الصف (اختياري)</label>
                  <input type="text" class="form-control" id="studentGrade" [(ngModel)]="newStudent.grade" name="grade" dir="rtl">
                  <small *ngIf="studentErrors.grade" class="text-danger">{{ studentErrors.grade }}</small>
                </div>
              </div>
              <div class="col-md-12">
                <div class="mb-3">
                  <label for="studentSubjects" class="form-label">المواد (مفصولة بفواصل)</label>
                  <input type="text" class="form-control" id="studentSubjects" [(ngModel)]="newStudent.subjectsString" name="subjectsString" (ngModelChange)="updateNewStudentSubjects($event)" placeholder="أدخل المواد مفصولة بفواصل (مثال: رياضيات, علوم)" dir="rtl">
                  <small *ngIf="studentErrors.subjects" class="text-danger">{{ studentErrors.subjects }}</small>
                </div>
                <div *ngIf="newStudent.subjects.length > 0" class="mb-3">
                  <label class="form-label">الحد الأدنى للمحاضرات لكل مادة</label>
                  <div *ngFor="let subject of newStudent.subjects; let i = index" class="mb-2">
                    <label for="minLectures{{i}}" class="form-label">{{ subject }}</label>
                    <input type="number" class="form-control" id="minLectures{{i}}" [(ngModel)]="newStudent.minLectures[i]" name="minLectures{{i}}" min="0" dir="rtl" required (ngModelChange)="validateMinLectures()">
                    <small *ngIf="studentErrors.minLectures && studentErrors.minLectures[i]" class="text-danger">{{ studentErrors.minLectures[i] }}</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="button-group">
              <button type="submit" class="btn btn-success" [disabled]="!isValidNewStudent()">إضافة طالب</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card shadow-sm mt-4" *ngIf="member">
        <div class="card-header bg-secondary text-white">
          <h4 class="mb-0">قائمة الطلاب</h4>
        </div>
        <div class="card-body">
          <div *ngIf="member.students.length === 0" class="alert alert-info">لا يوجد طلاب مسجلين.</div>
          <div class="table-responsive" *ngIf="member.students.length > 0">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>الاسم</th>
                  <th>البريد الإلكتروني</th>
                  <th>الهاتف</th>
                  <th>الصف</th>
                  <th>المواد (الحد الأدنى للمحاضرات)</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let student of member.students; let i = index">
                  <td>{{ student.name || 'غير محدد' }}</td>
                  <td>{{ student.email || 'غير محدد' }}</td>
                  <td>{{ student.phone || 'غير محدد' }}</td>
                  <td>{{ student.grade || 'غير محدد' }}</td>
                  <td>{{ getSubjectsDisplay(student.subjects) }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card shadow-sm mt-4" *ngIf="member">
        <div class="card-header bg-secondary text-white">
          <h4 class="mb-0">المحاضرات</h4>
        </div>
        <div class="card-body">
          <div *ngIf="showLectureWarning" class="alert alert-warning">
            تحذير: هذا العضو لديه طلاب بمحاضرات أقل من الحد الأدنى المطلوب.
          </div>
          <div *ngIf="member.lectures.length === 0" class="alert alert-info">لا توجد محاضرات مسجلة.</div>
          <div class="table-responsive" *ngIf="member.lectures.length > 0">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>اسم المحاضرة</th>
                  <th>بريد الطالب</th>
                  <th>المادة</th>
                  <th>التاريخ</th>
                  <th>المدة (دقائق)</th>
                  <th>الرابط</th>
                  <th>الإجراءات</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let lecture of member.lectures; let i = index">
                  <td>{{ lecture.name }}</td>
                  <td>{{ lecture.studentEmail }}</td>
                  <td>{{ lecture.subject }}</td>
                  <td>{{ lecture.date }}</td>
                  <td>{{ lecture.duration }}</td>
                  <td><a [href]="lecture.link" target="_blank" class="text-primary">{{ lecture.link }}</a></td>
                  <td>
                    <button class="btn btn-danger btn-sm" (click)="deleteLecture(i)">حذف</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card shadow-sm mt-4" *ngIf="member">
        <div class="card-header bg-secondary text-white">
          <h4 class="mb-0">المواد</h4>
        </div>
        <div class="card-body">
          <div *ngIf="member.subjects.length === 0" class="alert alert-info">لا توجد مواد مسجلة.</div>
          <ul class="list-group" *ngIf="member.subjects.length > 0">
            <li class="list-group-item" *ngFor="let subject of member.subjects">{{ subject }}</li>
          </ul>
        </div>
      </div>

      <div class="card shadow-sm mt-4" *ngIf="member">
        <div class="card-header bg-secondary text-white">
          <h4 class="mb-0">إدارة الرسائل</h4>
        </div>
        <div class="card-body">
          <div *ngIf="isLoadingMessages" class="alert alert-info">جاري تحميل الرسائل...</div>
          <div *ngIf="!isLoadingMessages && activeMessage" class="mb-3">
            <h5>الرسالة النشطة</h5>
            <p><strong>المحتوى:</strong> {{ activeMessage.content }}</p>
            <p><strong>تنتهي في:</strong> {{ activeMessage.displayUntil | date:'medium' }}</p>
            <div class="button-group">
              <button class="btn btn-danger" (click)="deleteMessage()">حذف الرسالة</button>
            </div>
          </div>
          <div *ngIf="!isLoadingMessages && !activeMessage" class="mt-3">
            <h5>إرسال رسالة جديدة</h5>
            <div class="mb-3">
              <label for="newMessageContent" class="form-label">نص الرسالة</label>
              <textarea class="form-control" id="newMessageContent" [(ngModel)]="newMessage.content" rows="4" dir="rtl"></textarea>
              <small *ngIf="messageError.content" class="text-danger">{{ messageError.content }}</small>
            </div>
            <div class="mb-3">
              <label for="newMessageDisplayDays" class="form-label">مدة العرض (أيام)</label>
              <input type="number" class="form-control" id="newMessageDisplayDays" [(ngModel)]="newMessage.displayDays" min="1" max="30" dir="rtl">
              <small *ngIf="messageError.displayDays" class="text-danger">{{ messageError.displayDays }}</small>
            </div>
            <div class="button-group">
              <button class="btn btn-success" (click)="sendMessage()" [disabled]="!newMessage.content.trim() || !newMessage.displayDays">إرسال الرسالة</button>
            </div>
          </div>
          <div *ngIf="!isLoadingMessages && !activeMessage && !newMessage.content" class="alert alert-info">
            لا توجد رسائل نشطة حاليًا. يمكنك إرسال رسالة جديدة.
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
